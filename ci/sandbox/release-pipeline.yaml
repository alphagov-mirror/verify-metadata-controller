---
apiVersion: concourse.k8s.io/v1beta1
kind: Pipeline
metadata:
  labels:
    controller-tools.k8s.io: "1.0"
  name: release
spec:
  exposed: true
  config:

    github_source: &github_source
      uri: https://github.com/alphagov/verify-metadata-controller.git
      organization: alphagov
      owner: alphagov
      repository: verify-metadata-controller
      github_api_token: ((github.api-token))
      access_token: ((github.api-token))
      approvers: ((trusted-developers.github-accounts))
      required_approval_count: 0

    harbor_source: &harbor_source
      username: ((harbor.harbor_username))
      password: ((harbor.harbor_password))
      harbor:
        prevent_vul: "false"
      notary:
        url: ((harbor.notary_url))
        root_key: ((harbor.root_key))
        delegate_key: ((harbor.ci_key))
        passphrase:
          root: ((harbor.notary_root_passphrase))
          snapshot: ((harbor.notary_snapshot_passphrase))
          targets: ((harbor.notary_targets_passphrase))
          delegation: ((harbor.notary_delegation_passphrase))

    task_toolbox: &task_toolbox
      type: docker-image
      source:
        repository: ((concourse.task-toolbox-image))
        tag: ((concourse.task-toolbox-tag))

    image_tag: &image_tag
      tag_file: src/.git/short_ref
      tag_as_latest: true
      tag_prefix: v

    resource_types:

    - name: github
      type: registry-image
      source:
        repository: ((concourse.github-resource-image))
        tag: ((concourse.github-resource-tag))

    - name: harbor
      type: docker-image
      privileged: true
      source:
        repository: ((concourse.harbor-resource-image))
        tag: ((concourse.harbor-resource-tag))

    resources:

    - name: src
      type: github
      icon: github-circle
      source:
        <<: *github_source
        branch: sandbox

    - name: release
      type: harbor
      icon: tag
      source:
        <<: *harbor_source
        repository: registry.((cluster.domain))/eidas/vmc-release

    - name: vmc-image
      type: harbor
      icon: docker
      source:
        <<: *harbor_source
        repository: registry.((cluster.domain))/eidas/metadata-controller

    - name: cloudhsm-image
      type: harbor
      icon: folder-key-network
      source:
        <<: *harbor_source
        repository: registry.((cluster.domain))/eidas/cloudhsm-client

    - name: alpine-image
      type: docker-image
      icon: toolbox
      source:
        repository: alpine
        tag: 3

    jobs:

    - name: build
      serial: true
      plan:

      - get: src
        trigger: true

      - put: vmc-image
        get_params: {skip_download: true}
        params:
          build: src
          <<: *image_tag

    - name: release
      serial: true
      plan:

      - in_parallel:
        - get: src
          passed: [build]
          trigger: true
        - get: vmc-image
          passed: [build]
          trigger: true
          params: {skip_download: true}
        - get: cloudhsm-image
          trigger: true
          params: {skip_download: true}
        - get: alpine-image
          params: {rootfs: true}

      - task: generate-chart-values
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: src
          - name: vmc-image
          - name: cloudhsm-image
          outputs:
          - name: chart-values
          run:
            path: /bin/bash
            args:
              - -euc
              - |
                echo "Generating helm values for latest image versions..."
                mkdir -p chart-values
                cat << EOF > ./overrides.yaml
                vmc:
                  image:
                    repository: $(cat vmc-image/repository)@$(cat vmc-image/digest | cut -d ':' -f 1)
                    tag: $(cat vmc-image/digest | cut -d ':' -f 2)
                hsm:
                  image:
                    repository: $(cat cloudhsm-image/repository)@$(cat cloudhsm-image/digest | cut -d ':' -f 1)
                    tag: $(cat cloudhsm-image/digest | cut -d ':' -f 2)
                EOF
                echo "Merging with chart values..."
                spruce merge ./src/chart/values.yaml ./overrides.yaml | tee -a chart-values/values.yaml

      - task: generate-chart-version
        config:
          platform: linux
          image_resource: *task_toolbox
          outputs:
          - name: chart-version
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              echo "Generating datetime-based Sandbox release number..."
              echo "0.$(date +%Y%m%d).$(date +%I%M%S)" > chart-version/tag
              cat chart-version/tag

      - task: generate-chart-package
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: src
          - name: chart-version
          - name: chart-values
          outputs:
          - name: chart-package
          params:
            CLUSTER_PRIVATE_KEY: ((cluster.privateKey))
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              echo "Preparing keyring..."
              echo "${CLUSTER_PRIVATE_KEY}" > key
              gpg --import key
              gpg --export-secret-keys > ~/.gnupg/pubring.gpg
              KEY_ID="$(gpg --list-secret-keys --with-colons  | awk -F: '/uid:/ {print $10}' | head -n1)"
              echo "Building chart with release values..."
              CHART_NAME=$(yq . < ./src/chart/Chart.yaml | jq -r .name)
              cp -r "./src/chart" "./${CHART_NAME}"
              cp "./chart-values/values.yaml" "./${CHART_NAME}/values.yaml"
              mkdir -p chart-package
              APP_VERSION=$(cat ./src/.git/short_ref)
              CHART_VERSION=$(cat ./chart-version/tag)
              echo "Generating signed (${KEY_ID}) helm package for ${CHART_NAME} at app-version: '${APP_VERSION}' chart-version: '${CHART_VERSION}'..."
              helm package \
                --app-version "${APP_VERSION}" \
                --version "${CHART_VERSION}" \
                --destination "./chart-package/" \
                --save=false \
                --sign \
                --key "${KEY_ID}" \
                "./${CHART_NAME}"
              echo "Verifying package signature..."
              helm verify ./chart-package/*.tgz
              echo "OK!"

      - task: package-release
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: chart-package
          - name: chart-version
          - name: alpine-image
          outputs:
          - name: alpine-image
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              mkdir -p vmc-chart-package
              cp chart-version/tag vmc-chart-package/
              cp -r chart-package/* vmc-chart-package/
              tar -rf alpine-image/rootfs.tar vmc-chart-package/

      - put: release
        get_params: {skip_download: true}
        params:
          import_file: alpine-image/rootfs.tar
          <<: *image_tag
