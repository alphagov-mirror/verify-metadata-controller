# Running mdgen

mdgen relies on the aws HSM client which won't run on MacOS.
To get around this we can use docker to provide a Linux system on which
to install the client.

## mdgen use cases

mdgen is setup for two separate use cases. One where a SAML signing certificate 
is generated by the Verify metadata controller via the HSM (proxy node use case) 
and the other where a SAML signing and SAML encryption certificate are provided 
(connector node use case). The two cases require different command line options.
Here are examples:

#### Case one (proxy node)

```
   mdgen proxy <yaml_definition_file.yml> <metadata_signing_certificate.pem> --hsm-metadata-signing-label <metadata_signing_label> --output <metadata_output_file.xml> --hsm-saml-signing-cert-file <saml_signing_cert_file.pem> --hsm-saml-signing-label <hsm_saml_signing_label>
```

#### Case two (connector node)

```
    mdgen connector <yaml_definition_file.yml> <metadata_signing_certificate.pem>  --hsm-metadata-signing-label <metadata_signing_label> --output <metadata_output_file.xml> --supplied-saml-signing-cert-file <saml_signing_cert_file.pem> --supplied-saml-encryption-cert-file <saml_encryption_cert_file.pem> 
```

## Building the docker image

In the directory `docker`, run the following command:

```bash
docker build -t mdgen:docker .
```

The first time you run this command, it will take a long time as it
will download everything it needs to create an image.

## Running the docker image

In order to be able to use the hsm you need a username and a password for
the aws client to be able to log in.  The aws client can pick the username
and password up from environment variables.

It's also necessary for that cloudhsm user to have a correct key-pair and
a certificate signed with that key-pair.  For best results, use `cu9` for
the username and find out the password.  The key-pair is hard-coded into 
the test as the `--hsm-metadata-signing-label` parameter and the 
certificate is `test/cloudhsmkeycert.rsa.pem`.

Key-pairs and certificates can be generated using `cloudhsmtool` which is 
a sibling project of this project.

There is a bash script called launch-docker.bash in the `docker` directory
which exports the necessary environment variables to the docker container.
Run it with the following command (with appropriate values for username 
and password) to start the container and run the integration tests:

```
HSM_USER=<user> HSM_PASSWORD=<password> ./launch-docker.bash 
```

This will start the aws client and run the integration tests in 
`docker/integration_tests`.  You will need to be able to access the cloud 
hsm so you may need to be connected to the VPN.

Once the tests have run you will be left in the docker container. To re-run
the tests you can just use the command `cucumber`. You can make changes to
the features and step definitions and then run them with `cucumber`
without having to restart the container.  To run a particular test you
can use a command like `cucumber features/feature/launch.feature:12` where
`launch.feature` is the feature file you're interested in and `:12` is the
first line of the feature you want to run.